
SELECT 
    dp.name AS UserName,
    dp.type_desc AS UserType,
    dp.create_date AS UserCreatedDate,
    dp.modify_date AS UserModifiedDate,
    dp.authentication_type_desc AS AuthenticationType,
    r.name AS RoleName,
    r.type_desc AS RoleType,
    CASE 
        WHEN dp.is_fixed_role = 1 THEN 'Yes'
        ELSE 'No'
    END AS IsFixedRole,
    dp.default_schema_name AS DefaultSchema
FROM sys.database_principals dp
LEFT JOIN sys.database_role_members drm ON dp.principal_id = drm.member_principal_id
LEFT JOIN sys.database_principals r ON drm.role_principal_id = r.principal_id
WHERE dp.type IN ('S', 'U', 'G', 'E', 'X') -- S=SQL user, U=Windows user, G=Windows group, E=External user, X=External group
  AND dp.name NOT IN ('dbo', 'guest', 'INFORMATION_SCHEMA', 'sys')
  AND dp.is_fixed_role = 0
ORDER BY dp.name, r.name;

